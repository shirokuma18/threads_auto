name: Threads PDCA Automation

on:
  # 1æ—¥4å›æŠ•ç¨¿ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬æ™‚é–“ 8æ™‚ã€12æ™‚ã€18æ™‚ã€21æ™‚ï¼‰
  schedule:
    - cron: '0 23,3,9,12 * * *'

    # 3æ—¥ã”ã¨ã«PDCAãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆæ—¥æœ¬æ™‚é–“ 20æ™‚ï¼‰
    - cron: '0 11 */3 * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'post'
        type: choice
        options:
          - post
          - pdca
          - full-cycle

jobs:
  # æŠ•ç¨¿ã‚¸ãƒ§ãƒ–ï¼ˆ1æ—¥4å›ï¼‰
  post-threads:
    runs-on: ubuntu-latest
    # 23,3,9,12æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œã€ã¾ãŸã¯post/full-cycleãƒ¢ãƒ¼ãƒ‰
    if: |
      (github.event.schedule == '0 23,3,9,12 * * *') ||
      (github.event.schedule == '40 0 * * *') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.mode == 'post' || github.event.inputs.mode == 'full-cycle'))
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests

      - name: å‰å›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒ
        uses: actions/cache@v3
        with:
          path: threads.db
          key: threads-db-v2-${{ github.sha }}
          restore-keys: |
            threads-db-v2-

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
        run: |
          if [ ! -f threads.db ]; then
            echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ä¸­..."
            python3 migrate_to_sqlite.py init
            python3 threads_sqlite.py import --csv posts_schedule.csv
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†"
          else
            echo "âœ… æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨"

            # ä»Šæ—¥æŠ•ç¨¿ã™ã¹ãpendingæŠ•ç¨¿æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            CURRENT_DATE=$(TZ=Asia/Tokyo date '+%Y-%m-%d')
            TODAY_PENDING=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='pending' AND DATE(scheduled_at) = '$CURRENT_DATE'")
            TODAY_POSTED=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='posted' AND DATE(posted_at) = '$CURRENT_DATE'")
            TOTAL_PENDING=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='pending'")

            echo "ğŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ¥DB: pending $TOTAL_PENDING ä»¶ (ä»Šæ—¥ $TODAY_PENDING ä»¶) / posted (ä»Šæ—¥ $TODAY_POSTED ä»¶)"

            # ä»Šæ—¥æŠ•ç¨¿ã™ã¹ãpendingæŠ•ç¨¿ãŒãªãã€ã‹ã¤ä»Šæ—¥ã®postedæŠ•ç¨¿ã‚‚ãªã„å ´åˆã®ã¿ãƒªã‚«ãƒãƒªãƒ¼
            if [ "$TODAY_PENDING" -eq 0 ] && [ "$TODAY_POSTED" -eq 0 ]; then
              echo "âš ï¸  ä»Šæ—¥ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®threads.dbã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
              git checkout threads.db
              TODAY_PENDING_NEW=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='pending' AND DATE(scheduled_at) = '$CURRENT_DATE'")
              TOTAL_PENDING_NEW=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='pending'")
              echo "ğŸ“Š ãƒªãƒã‚¸ãƒˆãƒªDB: pending $TOTAL_PENDING_NEW ä»¶ (ä»Šæ—¥ $TODAY_PENDING_NEW ä»¶)"
            elif [ "$TODAY_POSTED" -gt 0 ]; then
              echo "âœ… ä»Šæ—¥ã™ã§ã« $TODAY_POSTED ä»¶æŠ•ç¨¿æ¸ˆã¿ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥DBã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            fi
          fi

      - name: æŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: python threads_sqlite.py post
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

      - name: æŠ•ç¨¿çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜
        run: |
          # æŠ•ç¨¿ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --quiet threads.db; then
            echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ãªã—ï¼ˆæŠ•ç¨¿ãªã—ï¼‰"
          else
            echo "ğŸ“Š æŠ•ç¨¿çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆ"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add threads.db

            # æŠ•ç¨¿æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            POSTED_COUNT=$(sqlite3 threads.db "SELECT COUNT(*) FROM posts WHERE status='posted' AND DATE(posted_at) = date('now', '+9 hours')")

            git commit -m "Update database: ${POSTED_COUNT} posts published [skip ci]" || true
            git push || echo "âš ï¸  ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ï¼ˆç«¶åˆã®å¯èƒ½æ€§ï¼‰"
          fi

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¿å­˜
        uses: actions/cache/save@v3
        if: always()
        with:
          path: threads.db
          key: threads-db-v2-${{ github.sha }}

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
        if: always()
        run: |
          if [ -f threads.db ]; then
            python3 check_db_size.py --quiet || true
          fi
  
  # PDCAãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¸ãƒ§ãƒ–ï¼ˆ3æ—¥ã”ã¨ or æ‰‹å‹•ï¼‰
  pdca-report:
    runs-on: ubuntu-latest
    if: |
      (github.event.schedule == '0 11 */3 * *') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.mode == 'pdca' || github.event.inputs.mode == 'full-cycle'))
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests

      - name: å‰å›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒ
        uses: actions/cache@v3
        with:
          path: threads.db
          key: threads-db-v2-${{ github.sha }}
          restore-keys: |
            threads-db-v2-

      - name: PDCAãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: python threads_sqlite.py pdca
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
      
      - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pdca_report.md || true
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š Update PDCA report [skip ci]"
          git push || true
      
      - name: GitHub Issueã«ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            let reportContent = '';
            try {
              reportContent = fs.readFileSync('pdca_report.md', 'utf8');
            } catch (error) {
              reportContent = 'âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
            
            // Issueã‚’ä½œæˆ
            const date = new Date().toLocaleDateString('ja-JP');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š PDCA ãƒ¬ãƒãƒ¼ãƒˆ - ${date}`,
              body: reportContent,
              labels: ['pdca-report', 'analytics']
            });
      
      - name: åˆ†æçµæœã‚’é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: always()
        run: |
          echo "âœ… PDCAãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ“‹ Issuesã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„"
          cat pdca_report.md || echo "ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
