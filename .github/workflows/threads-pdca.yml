name: Threads PDCA Automation

on:
  # æŠ•ç¨¿ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ãŠãã«å®Ÿè¡Œï¼‰
  schedule:
    # GitHub Actionsã®cronã¯ä¸å®‰å®šãªãŸã‚ã€5åˆ†ãŠãã«å®Ÿè¡Œ
    # å®Ÿéš›ã®æŠ•ç¨¿ã¯1æ—¥25ä»¶åˆ¶é™ã§åˆ¶å¾¡
    - cron: '*/10 * * * *'

    # æ¯æœã®ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿ï¼ˆæ—¥æœ¬æ™‚é–“ 9æ™‚ï¼‰
    - cron: '0 0 * * *'

    # 3æ—¥ã”ã¨ã«PDCAãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆæ—¥æœ¬æ™‚é–“ 20æ™‚ï¼‰
    - cron: '0 11 */3 * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'post'
        type: choice
        options:
          - post
          - daily-report
          - pdca
          - full-cycle

permissions:
  contents: write

jobs:
  # æŠ•ç¨¿ã‚¸ãƒ§ãƒ–ï¼ˆ1æ—¥4å›ï¼‰
  post-threads:
    runs-on: ubuntu-latest
    # æŠ•ç¨¿æ™‚åˆ»ã«å®Ÿè¡Œã€ã¾ãŸã¯post/full-cycleãƒ¢ãƒ¼ãƒ‰
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.mode == 'post' || github.event.inputs.mode == 'full-cycle'))

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (automation ãƒ–ãƒ©ãƒ³ãƒ)
        uses: actions/checkout@v3
        with:
          ref: automation
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests

      - name: Gitè¨­å®š
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: ã‚·ãƒ³ãƒ—ãƒ«æŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: python3 threads_simple.py
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

      - name: æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: always()
        run: |
          # .last_posted_at ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå®Ÿè¡ŒçŠ¶æ…‹ã®ä¿å­˜ï¼‰
          if [ -f .last_posted_at ]; then
            git add .last_posted_at

            # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
            if ! git diff --quiet HEAD .last_posted_at 2>/dev/null; then
              LAST_TIME=$(cat .last_posted_at)
              git commit -m "Update: Last posted at $LAST_TIME [auto]"
              git push origin automation
              echo "âœ… æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»ã‚’ automation ãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜ã—ã¾ã—ãŸ"
            else
              echo "ğŸ“ å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            fi
          else
            echo "âš ï¸  .last_posted_at ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

  # PDCAãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¸ãƒ§ãƒ–ï¼ˆ3æ—¥ã”ã¨ or æ‰‹å‹•ï¼‰
  pdca-report:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 11 */3 * *') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.mode == 'pdca' || github.event.inputs.mode == 'full-cycle'))
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (automation ãƒ–ãƒ©ãƒ³ãƒ)
        uses: actions/checkout@v3
        with:
          ref: automation
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests

      - name: Gitè¨­å®š
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: PDCAãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: python threads_sqlite.py pdca
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

      - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          if [ -f pdca_report.md ]; then
            git add pdca_report.md
            git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š Update PDCA report [auto]"
            git push origin automation || true
          fi
      
      - name: GitHub Issueã«ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            let reportContent = '';
            try {
              reportContent = fs.readFileSync('pdca_report.md', 'utf8');
            } catch (error) {
              reportContent = 'âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
            
            // Issueã‚’ä½œæˆ
            const date = new Date().toLocaleDateString('ja-JP');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š PDCA ãƒ¬ãƒãƒ¼ãƒˆ - ${date}`,
              body: reportContent,
              labels: ['pdca-report', 'analytics']
            });
      
      - name: åˆ†æçµæœã‚’é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: always()
        run: |
          echo "âœ… PDCAãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ“‹ Issuesã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„"
          cat pdca_report.md || echo "ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

  # æ¯æœã®ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿ã‚¸ãƒ§ãƒ–ï¼ˆæ¯æ—¥9æ™‚ JSTï¼‰
  daily-report:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'daily-report')

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (main ãƒ–ãƒ©ãƒ³ãƒ)
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests python-dotenv

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒï¼ˆautomationãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ï¼‰
        run: |
          # automationãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰threads.dbã‚’å–å¾—
          git fetch origin automation
          git checkout origin/automation -- threads.db || echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          if [ -f threads.db ]; then
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒã—ã¾ã—ãŸ"
          else
            echo "ğŸ“¦ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
            python3 migrate_to_sqlite.py init
            python3 threads_sqlite.py import --csv posts_schedule.csv
          fi

      - name: æ¯æœã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»æŠ•ç¨¿
        run: python3 threads_sqlite.py daily-report
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’automationãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # automationãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
          git fetch origin automation
          git checkout automation

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¿½åŠ 
          git add threads.db

          if ! git diff --staged --quiet; then
            git commit -m "Update: Daily report posted [auto]"
            git push origin automation
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’automationãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜ã—ã¾ã—ãŸ"
          else
            echo "ğŸ“ å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi
