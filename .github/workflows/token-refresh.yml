name: Token Auto-Refresh

on:
  # æ¯é€±æ—¥æ›œæ—¥ 20:00 JST (11:00 UTC) ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 11 * * 0'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  check-and-refresh-token:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests

      - name: ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_token
        run: |
          python3 - <<'PYTHON_SCRIPT'
          import requests
          import os
          import sys
          from datetime import datetime

          access_token = os.getenv('THREADS_ACCESS_TOKEN')

          if not access_token:
              print("âŒ THREADS_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
              sys.exit(1)

          # ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          url = "https://graph.threads.net/v1.0/me"
          params = {
              "fields": "id,username",
              "access_token": access_token
          }

          try:
              response = requests.get(url, params=params)
              response.raise_for_status()
              data = response.json()

              print(f"âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™")
              print(f"User ID: {data.get('id')}")
              print(f"Username: @{data.get('username')}")

              # GitHub Actions ã®å‡ºåŠ›ã«ä¿å­˜
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"token_valid=true\n")
                  f.write(f"user_id={data.get('id')}\n")
                  f.write(f"username={data.get('username')}\n")

          except requests.exceptions.RequestException as e:
              print(f"âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™: {e}")

              if hasattr(e, 'response') and e.response is not None:
                  try:
                      error_detail = e.response.json()
                      error_msg = error_detail.get('error', {}).get('message', '')
                      print(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {error_msg}")

                      # ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã®å ´åˆ
                      if 'expired' in error_msg.lower():
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"token_valid=false\n")
                              f.write(f"token_expired=true\n")
                          sys.exit(0)  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶šè¡Œï¼ˆé€šçŸ¥ã®ãŸã‚ï¼‰
                  except:
                      pass

              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"token_valid=false\n")
                  f.write(f"token_expired=false\n")
              sys.exit(0)
          PYTHON_SCRIPT
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}

      - name: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è©¦è¡Œï¼ˆå®Ÿé¨“çš„ï¼‰
        id: refresh_token
        if: steps.check_token.outputs.token_valid == 'true'
        continue-on-error: true
        run: |
          python3 refresh_token.py || echo "âš ï¸  è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}

      - name: ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œé€šçŸ¥ï¼ˆIssueä½œæˆï¼‰
        if: steps.check_token.outputs.token_expired == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toLocaleDateString('ja-JP');

            // æ—¢å­˜ã®æœŸé™åˆ‡ã‚ŒIssueã‚’ãƒã‚§ãƒƒã‚¯
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'token-expired',
              state: 'open'
            });

            if (issues.data.length > 0) {
              console.log('æ—¢ã«æœŸé™åˆ‡ã‚Œé€šçŸ¥IssueãŒå­˜åœ¨ã—ã¾ã™');
              return;
            }

            // æ–°ã—ã„Issueã‚’ä½œæˆ
            const issueBody = [
              '## âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™',
              '',
              `**æ¤œå‡ºæ—¥æ™‚**: ${date}`,
              '',
              '### ğŸ“ å¯¾å‡¦æ–¹æ³•',
              '',
              '1. **æ–°ã—ã„çŸ­æœŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—**',
              '   - https://developers.facebook.com/tools/explorer/ ã«ã‚¢ã‚¯ã‚»ã‚¹',
              '   - Threads ã‚¢ãƒ—ãƒªã‚’é¸æŠ',
              '   - å¿…è¦ãªæ¨©é™ã‚’é¸æŠã—ã¦ã€ŒGenerate Access Tokenã€',
              '',
              '2. **é•·æœŸãƒˆãƒ¼ã‚¯ãƒ³ã«å¤‰æ›**',
              '   ```bash',
              '   python3 setup_long_lived_token.py',
              '   ```',
              '',
              '3. **GitHub Secrets ã‚’æ›´æ–°**',
              `   - [Settings > Secrets and variables > Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)`,
              '   - `THREADS_ACCESS_TOKEN` ã‚’æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°',
              '',
              '4. **ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º**',
              '',
              '### ğŸ“š è©³ç´°ãªã‚¬ã‚¤ãƒ‰',
              '',
              'è©³ã—ã„æ‰‹é †ã¯ [TOKEN_SETUP.md](./TOKEN_SETUP.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚',
              '',
              '---',
              '',
              '**è‡ªå‹•ç”Ÿæˆ**: Token Auto-Refresh Workflow'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”‘ Threads API ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™ - ${date}`,
              body: issueBody,
              labels: ['token-expired', 'urgent', 'automation']
            });

      - name: æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯çµæœã‚’ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          echo "## ğŸ”‘ Threads API ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_token.outputs.token_valid }}" == "true" ]; then
            echo "âœ… **ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- User ID: ${{ steps.check_token.outputs.user_id }}" >> $GITHUB_STEP_SUMMARY
            echo "- Username: @${{ steps.check_token.outputs.username }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“… æ¬¡å›ãƒã‚§ãƒƒã‚¯: 1é€±é–“å¾Œ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ å¯¾å‡¦æ–¹æ³•:" >> $GITHUB_STEP_SUMMARY
            echo "1. \`python3 setup_long_lived_token.py\` ã‚’å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
            echo "2. GitHub Secrets ã‚’æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ã¯ [TOKEN_SETUP.md](./TOKEN_SETUP.md) ã‚’å‚ç…§" >> $GITHUB_STEP_SUMMARY
          fi
