name: Threads Auto Posting

on:
  # 投稿スケジュール（定期実行）
  # 30分間隔で8:00~23:30 JST（32枠 × 1投稿 = 32投稿/日）
  schedule:
    # 7時（Daily Report専用）
    - cron: '0 22 * * *'   # 7:00 JST (Daily Report)
    # 8時台
    - cron: '0 23 * * *'   # 8:00 JST
    - cron: '30 23 * * *'  # 8:30 JST
    # 9時台
    - cron: '0 0 * * *'    # 9:00 JST
    - cron: '30 0 * * *'   # 9:30 JST
    # 10時台
    - cron: '0 1 * * *'    # 10:00 JST
    - cron: '30 1 * * *'   # 10:30 JST
    # 11時台
    - cron: '0 2 * * *'    # 11:00 JST
    - cron: '30 2 * * *'   # 11:30 JST
    # 12時台
    - cron: '0 3 * * *'    # 12:00 JST
    - cron: '30 3 * * *'   # 12:30 JST
    # 13時台
    - cron: '0 4 * * *'    # 13:00 JST
    - cron: '30 4 * * *'   # 13:30 JST
    # 14時台
    - cron: '0 5 * * *'    # 14:00 JST
    - cron: '30 5 * * *'   # 14:30 JST
    # 15時台
    - cron: '0 6 * * *'    # 15:00 JST
    - cron: '30 6 * * *'   # 15:30 JST
    # 16時台
    - cron: '0 7 * * *'    # 16:00 JST
    - cron: '30 7 * * *'   # 16:30 JST
    # 17時台
    - cron: '0 8 * * *'    # 17:00 JST
    - cron: '30 8 * * *'   # 17:30 JST
    # 18時台
    - cron: '0 9 * * *'    # 18:00 JST
    - cron: '30 9 * * *'   # 18:30 JST
    # 19時台
    - cron: '0 10 * * *'   # 19:00 JST
    - cron: '30 10 * * *'  # 19:30 JST
    # 20時台
    - cron: '0 11 * * *'   # 20:00 JST
    - cron: '30 11 * * *'  # 20:30 JST
    # 21時台
    - cron: '0 12 * * *'   # 21:00 JST
    - cron: '30 12 * * *'  # 21:30 JST
    # 22時台
    - cron: '0 13 * * *'   # 22:00 JST
    - cron: '30 13 * * *'  # 22:30 JST
    # 23時台
    - cron: '0 14 * * *'   # 23:00 JST
    - cron: '30 14 * * *'  # 23:30 JST

  # 手動実行
  workflow_dispatch:

jobs:
  # 毎朝のDaily Report投稿（7:00 JST = 22:00 UTC前日）
  daily-report:
    runs-on: ubuntu-latest
    # 7:00 JSTのcronでのみ実行
    if: github.event.schedule == '0 22 * * *'

    steps:
      - name: リポジトリをチェックアウト (main ブランチ)
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python環境をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 依存関係をインストール
        run: pip install requests python-dotenv

      - name: Daily Reportを生成・投稿
        run: python3 threads_simple.py daily-report
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

  post:
    runs-on: ubuntu-latest
    # 7:00 JST (Daily Report)以外のスケジュールで実行
    if: github.event.schedule != '0 22 * * *'

    steps:
      - name: リポジトリをチェックアウト (main ブランチ)
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Python環境をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 依存関係をインストール
        run: pip install requests python-dotenv

      - name: シンプル投稿スクリプトを実行
        run: python3 threads_simple.py
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
