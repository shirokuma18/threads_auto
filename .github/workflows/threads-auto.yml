name: Threads Auto Posting

on:
  # æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå®šæœŸå®Ÿè¡Œï¼‰
  schedule:
    # æ¯æ—¥ 8:00, 12:00, 15:00, 18:00, 21:00, 23:00 JST (UTC: 23:00, 3:00, 6:00, 9:00, 12:00, 14:00)
    - cron: '0 23 * * *'  # 8:00 JST
    - cron: '0 3 * * *'   # 12:00 JST
    - cron: '0 6 * * *'   # 15:00 JST
    - cron: '0 9 * * *'   # 18:00 JST
    - cron: '0 12 * * *'  # 21:00 JST
    - cron: '0 14 * * *'  # 23:00 JST

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (automation ãƒ–ãƒ©ãƒ³ãƒ)
        uses: actions/checkout@v3
        with:
          ref: automation
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests python-dotenv

      - name: Gitè¨­å®š
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: ã‚·ãƒ³ãƒ—ãƒ«æŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: python3 threads_simple.py
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

      - name: æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: always()
        run: |
          if [ -f .last_posted_at ]; then
            git add .last_posted_at

            if ! git diff --quiet HEAD .last_posted_at 2>/dev/null; then
              LAST_TIME=$(cat .last_posted_at)
              git commit -m "Update: Last posted at $LAST_TIME [auto]"
              git push origin automation
              echo "âœ… æœ€çµ‚å®Ÿè¡Œæ™‚åˆ»ã‚’ automation ãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜ã—ã¾ã—ãŸ"
            else
              echo "ğŸ“ å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            fi
          else
            echo "âš ï¸  .last_posted_at ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

  # æ¯æœã®ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿ï¼ˆæ¯æ—¥9æ™‚ JSTï¼‰
  daily-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *'  # 9:00 JST (0:00 UTC)

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (main ãƒ–ãƒ©ãƒ³ãƒ)
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests python-dotenv

      - name: Daily Reportã‚’ç”Ÿæˆãƒ»æŠ•ç¨¿
        run: python3 threads_simple.py daily-report
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

  # Merge automation â†’ mainï¼ˆæ¯æ—¥0æ™‚ JSTï¼‰
  merge-to-main:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 15 * * *'
    needs: post

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: automation ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒãƒ¼ã‚¸
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git fetch origin automation
          git merge origin/automation -m "Merge automation updates to main [auto]"
          git push origin main
